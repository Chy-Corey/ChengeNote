## 层次分析法

层次分析法是将定性问题定量化处理的一种有效手段。层次分析法(AHP)是一种定性和定量相结合的、系统化的、层次化的分析方法。层次分析法是系统分析的数学工具之一。

### 步骤

#### 1. 建立层次结构模型

一般分为三层，最上层为目标层，最下面为方案曾，中间为准则层(指标层)。

​									买钢笔                                                                   目标层                                                                                                                                                                                                                                                       ——————————  | ——————————                                                                                                                                                                            |                  |                  |                    |                |                                                                                                                                                                        质量          颜色             价格              外形          实用                              准则层                                                                                                                                                                                                                              										|                                                                                                                                                                                                                         

​							  可供选择的笔                                                               方案层

在层次划分及因素选取时，有**三个注意点**：

1. 上层对下层有支配作用
2. 同一层因素不存在支配关系，相互独立(比如价格和外形不会相互影响)
3. 每层因素一般不超过九个

#### 2. 构造成对比较阵

面对的决策问题：要比较n个因素X1...Xn对目标z的影响。我们要确定它们在z中所占的权重，即这n个因素对目标z的相对重要性。我们用两两比较的方法将各因素的重要性量化。

矩阵元素数值的选取方法：

| Xi：Xj | 重要性相同 | 稍重要 | 重要 | 很重要 | 绝对重要 |
| :----: | :--------: | :----: | :--: | :----: | :------: |
|  Aij   |     1      |   3    |  5   |   7    |    9     |

例如：评价电影的好坏

​	                              电影好坏                                                                   目标层                                                                                                                                                                                                                                                       ——————————  | ——————————                                                                                                                                                                             |                                      |                                       |                                                                                                                                                                                  娱乐性X1                 艺术性X2                         教育性X3                           准则层                                                                                                                                                                                                                              										|                                                                                                                                                                                                                         

​				    电影1好/坏，电影2好/坏...                                                    方案层

根据一定的评定，认为：                          **X1      X2      X3**

X1:X2 = 3	稍重要                      	 **X1|     1        3        5   |**

X1:X3 = 5	重要                   →→	**X2|   1/3       1        3   |**

X2:X3 = 3	稍重要                       	**X3|   1/5     1/3      1   |**

**注意：是横的比竖的**

上述矩阵即为相对比较矩阵。

但是，存在逻辑一致性问题。如果X1:X2 = X2:X3 = 3,那么根据逻辑的绝对一致性，X1:X3 = 9，但是实际上等于5，这个问题就是逻辑一致性问题。一般来说，我们是没有办法使之完全一致的。

由于客观事物的复杂性以及人类认知的多样性，构造出的成对比较阵A常常是不一致阵。若不一致性达到很严重的程度，会影响评价系统的准确性。所以，**矩阵的不一致性要被限定在一个合理的范围内**。

##### 成对比较阵的不一致性

可以证明：n阶成对比较矩阵A是一致阵，当且仅当A的最大特征值Max(λ）=  n。因此计算A的最大特征值就可以判断A是否是一致阵。如果Max(λ）>  n，且λ越大，不一致程度越严重。

##### λ计算

```matlab
clc;clear;
% [V,D] = eig(A) 
A = [1 2 4;4 0 7;9 1 3];
[V,D] = eig(A)
%其中D为特征值构成的对角阵，每个特征值对应V矩阵中列向量(也正是其特征向量),如果只有一个返回变量，则得到该矩阵特征值构成的列向量。
```

#### 3. 一致性检验

可以推测，矩阵A的不一致性是不可避免的，但只要它的不一致性不是非常严重，我们还是可以接受的。萨迪给出了一个衡量可接受指标以及计算该指标的方法。共分三步：

1. 计算一致性指标CI(consistency index)用来衡量A的不一致程度。

   ​	CI = (λ - n) / (n - 1)

2. 查找相应的平均随即一致性指标RI(random index)

      RI = (λ‘ - n) / (n - 1)

   | n    | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 11   |
   | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
   | RI   | 0    | 0    | 0.58 | 0.90 | 1.12 | 1.24 | 1.32 | 1.41 | 1.45 | 1.49 | 1.51 |

3. 计算一致性比例CR(consistency ratio)

      CR = CI / RI

结论：当CR < 0.1 时，认为矩阵A的不一致性可以接受，当CR >= 0.1时，则应该修改比较阵A直至可接受为止。

#### 4. 计算权重向量

当陈谷底比较矩阵A构造完成后，计算此层中n个因素在目标z中所占的比重，将这些比重写成向量并归一化即可求得权向量W。

#### 5. 层次总排序，即求各方案的综合得分

前面四个步骤已经求得一层中各因素的权重，这个过程称为但层次排序。不妨设准则层权向量W = （w1,w2,...,wn)’，而方案层有l个方案可供选择，且每个方案的权向量分别为b1,b2,...,bn。那么每个方案对最终目标的影响程度C1,C2,...,Cn就可以计算出来：

C = B * W

#### 6. 对第二层和第三层都要计算权重向量

第二层是条件之间的重要性比较，第三层是决策之间相对于条件的优缺性的比较。第二层比较好理解，第三层举个例子：

准则层有：景色、费用、居住、饮食、旅途；方案层有：苏州、杭州、桂林。

我们计算第二层的权重，得出了“景色、费用、居住、饮食、旅途”之间重要性的关系。还要计算第三层中：相对于景色，苏州杭州桂林之间的比较；相对于费用，苏州杭州桂林之间的比较；相对于居住，苏州杭州桂林之间的比较；相对于饮食，苏州杭州桂林之间的比较；相对于旅途，苏州杭州桂林之间的比较。那么第三层就有五组权重向量。

### 举例

例：旅游地选择问题

```matlab
function main()
    % 1. 建立层次结构模型
    % 目标层Z：选择旅游地                                                                                       
    % 准则层A：景色、费用、居住、饮食、旅途                                                                           % 方案层B：苏州、杭州、桂林
    addpath(genpath('.\lib\decision_model'));
    % 2. 构造准则层A的成对比较阵
    A = [1 1/2 4 3 3; 2 1 7 5 5; 1/4 1/7 1 1/2 1/3; 1/3 1/5 2 1 1; 1/3 1/5 3 1 1];
    % 3. 一致性检验
    [W, result] = conformance_check(A);
    %disp(W);
    %disp(result);
    if result == 0
      disp('矩阵A不符合一致性检验');
      quit;
    end
    % 4. 构造方案层的成对角矩阵，并对其进行一致性检验
    B1 = [1 2 5; 1/2 1 2; 1/5 1/2 1];%相对于景色
    B2 = [1 1/3 1/8; 3 1 1/3; 8 3 1];%相对于费用
    B3 = [1 1 3; 1 1 3; 1/3 1/3 1];%相对于居住
    B4 = [1 3 4; 1/3 1 1; 1/4 1 1];%相对于饮食
    B5 = [1 1 1/4; 1 1 1/4; 4 4 1];%相对于旅途
    B(:,:,1) = B1;B(:,:,2) = B2;B(:,:,3) = B3;B(:,:,4) = B4;B(:,:,5) = B5;%这么写是为了代码可读性
    W_B = zeros(3,5);RESULT = zeros(5,1);% 与分配内存
    for i = 1:5
        [W_B(:,i),RESULT(i)] =  conformance_check(B(:,:,i));
        %disp(W_B(:,i));
        %disp(RESULT(i));
        if RESULT(i) == 0
        	disp('矩阵：B');disp(i);disp('不符合一致性检验');
       	end
    end	
    outcome = W_B * W;
    disp(outcome);
end
```

```matlab
function [W,result] = conformance_check(A)
	% 一致性检验函数，返回特征向量以及检验结果
  RI = [0 0 0.58 0.90 1.12 1.24 1.32 1.41 1.45 1.49 1.51];
  [V,D] = eig(A);
  lambda = max(max(D));%最大特征值
  [n,n] = size(A);
  transfer = D(1,1);
  pos = 1;
  for h = 2:n %锁定最大特征值所在的位置，以便确定特征向量
    if D(h,h) > transfer
      transfer = D(h,h);
      pos = h;
    end
  end	
  W = abs(V(:,pos));%准则层A的特征向量
  W = W/sum(W);%归一化
  CI = (lambda-n)/(n-1);
  CR = CI/RI(n);
  disp('CI = ');disp(CI);
  disp('RI = ');disp(RI(n));
  disp('CR = ');disp(CR);
  if CR<0.1
    result = 1;
  else
    result = 0;
  end
end
```

### 不足之处

1. 只能从现有的方案选出较优的一个，不能提供一个新的或者更好的方案
2. 判断结果比较粗糙，不精确
3. 建立层级结构和成对比较矩阵时，主观因素起很大作用，这是一个无法克服的缺点。